#!/usr/bin/env node
import t from"env-paths";import e from"node:fs";import n from"node:path";import"dotenv/config";import{Client as r,GatewayIntentBits as o,SnowflakeUtil as s,Collection as a}from"discord.js";import i from"csv-parser";import{csvFormat as c}from"d3-dsv";import{google as d}from"googleapis";import l from"node:http";import u from"node:url";import p from"open";import{spawn as m}from"node:child_process";import{scaleUtc as h,scaleLinear as f}from"d3-scale";import{line as g,curveBumpX as w,pie as y,arc as v}from"d3-shape";import $ from"node:https";import S from"sharp";var x=t("dpm-v1"),A=n.join(x.data,"csv/"),T=n.join(x.data,"gist/"),E=x.cache;async function I(){return new Promise(((t,n)=>{e.rm(E,{force:!0,recursive:!0},(e=>{if(e)return n(e);t()}))}))}function C(){var t=new Set,e=new Map,n=new Map;return{get newSongs(){return[...e.values()]},get newSongsCount(){return e.size},get allSongs(){return[...n.values(),...e.values()]},has:e=>t.has(e),add(n){return t.has(n.url)||(t.add(n.url),e.set(n.url,n)),this},addFromCache(r){return t.has(r.url)||(t.add(r.url),n.set(r.url,r),e.delete(r.url)),this}}}e.existsSync(x.data)||e.mkdirSync(x.data),e.existsSync(A)||e.mkdirSync(A),e.existsSync(T)||e.mkdirSync(T),e.existsSync(E)||e.mkdirSync(E);var U=C(),P=C(),M=1431468e6;function _(t,e=[o.GuildMembers,o.GuildMessages,o.MessageContent,o.Guilds]){var n=process.env.DISCORD_CHANNEL_ID,s=process.env.DISCORD_TOKEN;if(!n)throw new Error("CHANNEL_ID is required");if(!s)throw new Error("TOKEN is required");var a=new r({intents:e});return new Promise(((e,r)=>{a.login(s),a.on("error",(()=>{a.destroy(),r()})),a.on("ready",(async()=>{var r=a.channels.cache.get(n);if(!r)throw new Error("Channel not found");var o=await t(a,r);a.destroy(),e(o)}))}))}function F(t){var e=s.timestampFrom(t),n=new Date(e);return`${n.getFullYear()}-${(n.getMonth()+1).toString().padStart(2,"0")}-${n.getDate().toString().padStart(2,"0")} ${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}:${n.getSeconds().toString().padStart(2,"0")}`}var b=function(){var t=new Set,e=new Map;return{get allFetched(){return e.size===t.size},get users(){return[...e.values()]},getUser:t=>e.get(t),add(e){return t.add(e),this},addFromCache(n){return t.has(n.id)||(this.add(n.id),e.set(n.id,n)),this},fetch:async()=>_((async(n,r)=>{(await r.guild.members.fetch()).forEach((n=>{if(!t.has(n.id))return;var{id:r,displayName:o,displayHexColor:s}=n,a=n.displayAvatarURL();e.set(r,{id:r,color:s,name:o,avatarUrl:a})}))}))}}();async function j(t){return new Promise((n=>{var r=[];if(!e.existsSync(t))return n(r);e.createReadStream(t).pipe(i({mapValues:({header:t,value:e})=>"date"===t?+e:e})).on("data",(t=>r.push(t))).on("end",(()=>n(r)))}))}async function k(t,r){var o=n.dirname(t);return e.existsSync(o)||e.mkdirSync(o,{recursive:!0}),new Promise(((n,o)=>{var s=c(r);e.writeFile(t,s,(t=>{if(t)return o(t);n()}))}))}var D=process.env.YOUTUBE_CLIENT_ID,R=process.env.YOUTUBE_CLIENT_KEY,N=process.env.YOUTUBE_REDIRECT_URL,L=process.env.YOUTUBE_PLAYLIST_ID,O=+(N?.match(/(?<=:)\d+/)?.[0]||"")||3e3;if(!D)throw new Error("Missing CLIENT_ID");if(!R)throw new Error("Missing CLIENT_KEY");if(!N)throw new Error("Missing REDIRECT_URL");async function Y(t){var e=[];let n,r="";do{n=await d.youtube("v3").playlistItems.list({auth:t,part:["snippet"],playlistId:L,pageToken:r,maxResults:50}),e.push(...n.data.items?.map((t=>({id:t.id??"",videoId:t.snippet?.resourceId?.videoId??"",title:t.snippet?.title??""}))).filter((t=>"Deleted video"!==t.title))??[]),r=n.data.nextPageToken??""}while(r);return e}async function z(t,e){var n=function(t,e){var n=new Map,r=new Map;return t.forEach((t=>{var o=String(t[e]),s=(n.get(o)||0)+1;n.set(o,s),s>1&&r.set(o,[...r.get(o)??[],{...t}])})),Array.from(r).map((([,t])=>t)).flat()}(await(e??Y(t)),"videoId");n.length>0&&console.log(`Found ${n.length} songs to delete`);for(var e of n)console.log("Removing duplicated: "+e.videoId),await d.youtube("v3").playlistItems.delete({auth:t,id:e.id})}async function B(t,e){for(var n of e){var[e]=n.url.match(/[a-zA-Z0-9_-]{11}/)||[];e&&(console.log(`adding song: ${n.title} to playlist`),await d.youtube("v3").playlistItems.insert({auth:t,part:["snippet"],requestBody:{snippet:{playlistId:L,resourceId:{kind:"youtube#video",videoId:e}}}}))}}var G="[0m",q="[33m";function K(t,e){var[,,...n]=process.argv;return!!n.includes(t)||!(!e||!n.includes(e))}function W(t){return new Promise(((e,n)=>{var r=m(t,{shell:!0});r.stdout.pipe(process.stdout),r.stderr.pipe(process.stderr),r.on("close",(()=>e())),r.on("disconnect",(()=>e())),r.on("exit",(()=>e())),r.on("error",n)}))}var H=864e5,Z=30.44*H;function V(t){var e=new Date(t),n=e.getUTCFullYear(),r=e.getUTCMonth();return Date.UTC(n,r,1)}function X(t){var e=t.filter((t=>t.date>M)),[n,r]=(o=e.map((t=>t.date)),[Math.min(...o),Math.max(...o)]);var o;var s=function(...t){var e=Math.min(...t),n=Math.max(...t);return Math.ceil((n-e)/Z)+1}(n,r),a=V(n),i=new Map(Array.from({length:s}).map(((t,e)=>[V(a+Z*e+3*H),new Map])));e.forEach((t=>{var e=V(t.date),n=i.get(e)||new Map,r=t.authorId;n.set(r,(n.get(r)||0)+1)}));var c=new Map;return i.forEach(((t,e)=>{t.forEach(((t,n)=>{var r=c.get(n)||[...i.keys()].map((t=>({timestamp:t,value:0}))),[o]=r.filter((t=>t.timestamp===e));o&&(o.value=t,c.set(n,r))}))})),[...c.entries()].map((([t,e])=>({user:b.getUser(t),list:e,minTime:n,maxTime:r})))}var J=function(){var t=new Map;return e.existsSync(n.join(E,"image"))||e.mkdirSync(n.join(E,"image")),{async get(e,n=128,r=128,o=95){this.hasInCache(e)&&await this.addFromCache(e),t.has(e)||await this.fetch(e);var s=t.get(e);return new Promise((t=>S(s).resize(n,r).webp({quality:o}).toBuffer().then((t=>"data:image/jpeg;base64,"+t.toString("base64"))).then(t).finally((()=>t("")))))},hasInCache:t=>e.readdirSync(n.join(E,"image")).some((e=>e.startsWith(t))),addFromCache:async r=>new Promise(((o,s)=>{if(t.has(r))return o();var a=b.getUser(r);if(!a?.avatarUrl)return s(`User: ${a} has no avatar`);var i=n.join(E,"image/",`${a.id}${n.extname(a.avatarUrl)}`);e.readFile(i,((e,n)=>{if(e)return s(e);t.set(a.id,n),o()}))})),fetch:async r=>new Promise(((o,s)=>{if(t.has(r))return o();var a=b.getUser(r);if(!a?.avatarUrl)return s(`User: ${a} has no avatar`);let i=Buffer.alloc(0);var c=e.createWriteStream(n.join(E,"image/",`${a.id}${n.extname(a.avatarUrl)}`));$.get(a.avatarUrl,(e=>{e.pipe(c),e.on("data",(t=>i=Buffer.concat([i,t]))),c.on("error",s),c.on("close",(()=>{t.set(a.id,i),o()}))}))}))}}();function Q(t){var e=[],n=new Map;let r,o=null;return{get attrs(){return n},set parent(t){o=t},get parent(){return o},setText(t){return r=`${t}`,this},setAttr(t,e){return n.set(t,`${e}`),this},setPosition({x:t,y:e,width:n,height:r}){return void 0!==t&&this.setAttr("x",t),void 0!==e&&this.setAttr("y",e),void 0!==n&&this.setAttr("width",n),void 0!==r&&this.setAttr("height",r),this},append(t){return e.push(t),t.parent=this,this},appendTo(t){return t.append(this),this},render(){var n=Array.from(this.attrs.entries()).map((([t,e])=>`${t}="${e}"`)).join(" "),o=this.attrs.size>0,s=e.map((t=>t.render())).join("");return`<${t}${o?" ":""}${n}>${s}${r||""}</${t}>`}}}function tt(t,e){var n=Q("svg").setPosition({width:t,height:e}).setAttr("viewbox",`0 0 ${t} ${e}`).setAttr("xmlns","http://www.w3.org/2000/svg").setAttr("xmlns:xlink","http://www.w3.org/1999/xlink").setAttr("fill","none"),r=Q("defs");return{...n,get defs(){return r}}}async function et(t){var n=25*t[0].list.length,r=350,o=20,s=20,a=20,i=60,c=t[0].list.at(0)?.timestamp??0,d=t[0].list.at(-1)?.timestamp??0,l=Math.max(...t.map((t=>Math.max(...t.list.map((t=>t.value)))))),u=h().domain([c,d]).range([a,n-s]),p=f().domain([0,l]).range([r-i,o]),m=g().x((t=>u(t.timestamp))).y((t=>p(t.value))).curve(w),y=tt(n,r).setAttr("font-size",10),v=Q("rect").setPosition({width:n,height:r}).setAttr("fill","#222").appendTo(y);Q("style").setText(t.map((({user:e},n)=>`.u-${e.id}{animation:h ${4*t.length}s linear ${4*(n-1)}s infinite;opacity:0}`)).join("")+`@keyframes h{${[[0,0],[1/t.length-.002,0],[1/t.length-.001,1],[2/t.length+.001,1],[2/t.length+.002,0],[1,0]].map((([t,e])=>`${100*t}%{opacity:${e}}`)).join("")}}`).appendTo(y);var $=[],S=Q("g").appendTo(y);t[0].list.forEach(((t,e,o)=>{var c=(n-s-a)/(o.length-1)*e+a-3,d=r-i+4,l=new Intl.DateTimeFormat("en-US",{month:"short"}),u=0===new Date(t.timestamp).getMonth(),p=u?new Date(t.timestamp).getFullYear():0,m=l.format(t.timestamp);S.append(Q("text").setPosition({x:c,y:d}).setAttr("transform",`rotate(90 ${c} ${d})`).setAttr("fill","#fff").setText(m+(u?" "+p:"")))}));var x=Q("g").appendTo(y);for(let t=0;t<=l;t++){if(t%10!=0&&t!==l)continue;var e=a-10,n=r-i-(r-o-i)/l*t;x.append(Q("text").setPosition({x:e,y:n}).setAttr("fill","#fff").setText(t))}for(var e of t){var{list:t,user:s}=e;if(!s)break;var i=Q("g").appendTo(y),l=52,h=await J.get(s.id,l,l);Q("image").setAttr("xlink:href",h).setPosition({x:a+20,y:o+20,width:48,height:48}).appendTo(i),i.setAttr("class","u-"+s.id),Q("path").setAttr("d",m([{timestamp:c,value:0},...t,{timestamp:d,value:0}])||"").setAttr("stroke-width",1).setAttr("stroke",s?.color||"red").setAttr("fill",(s?.color||"#ff0000")+"40").appendTo(i),Q("text").setPosition({x:a+25+l,y:o+20+l/2}).setAttr("font-size",20).setAttr("fill",s.color||"red").setText(s.name).appendTo(i);var f=tt(n,r).setAttr("font-size",10).append(v).append(i).append(S).append(x),g=Q("g").appendTo(f),w=t.reduce(((t,e)=>t+e.value),0)/t.length;t.forEach((t=>{Q("circle").setAttr("cx",u(t.timestamp)).setAttr("cy",p(t.value)).setAttr("r",2).setAttr("fill","#fff").appendTo(g),t.value>w&&Q("text").setAttr("x",u(t.timestamp)-5).setAttr("y",p(t.value)-6).setAttr("fill","#fff").setText(t.value).appendTo(g)})),$.push({content:f.render(),fileName:`${s.name}.svg`})}e.writeFile("download/pmstats-timegraph-animated.svg",y.render(),(t=>t&&console.log(t))),$.forEach((({content:t,fileName:n})=>e.writeFile("download/pmstats-timegraph-user-"+n,t,(t=>t&&console.log(t)))))}var nt=["#d9ed92","#b5e48c","#99d98c","#76c893","#52b69a","#34a0a4","#168aad","#1a759f","#1e6091","#184e77"];async function rt(t){var n=60*t.length,r=20,o=20,s=(n-r-20)/2,a=tt(600,n).setAttr("font-size",10).append(Q("rect").setPosition({width:600,height:n}).setAttr("fill","#222")),i=Q("g").setAttr("transform",`translate(${s+o},${s+r})`).appendTo(a),c=y().value((t=>t.count))(t),d=v().innerRadius(0).outerRadius(s),l=t.reduce(((t,e)=>t+e.count),0),u=t.map((({user:t,count:e},n)=>new Promise((u=>{Q("path").setAttr("d",d(c[n])).setAttr("fill",nt[n]).appendTo(i);let[p,m]=d.centroid(c[n]);p+=s+o,m+=s+r;var h=o+2*s+20,f=r+60*n;J.get(t.id,32,32).then((t=>{Q("image").setAttr("xlink:href",t).setPosition({x:h+32,y:f+5,width:32,height:32}).appendTo(a)})).then(u),Q("path").setAttr("d",`M${p} ${m}l0 -10L${h} ${f}l20 0`).setAttr("stroke",t?.color||"red").appendTo(a),Q("text").setText(`${t?.name} ${Math.floor(e/l*1e3)/10}% (${e})`).setPosition({x:h+30,y:f}).setAttr("fill",t?.color||"red").appendTo(a)}))));await Promise.all(u),e.writeFile("download/pmstats-piechart.svg",a.render(),(t=>t&&console.log(t)))}if(K("--rm-cache")&&await I(),K("--purge-data")&&await async function(){return Promise.all([I(),new Promise(((t,n)=>{e.rm(x.data,{force:!0,recursive:!0},(e=>{if(e)return n(e);t()}))}))])}(),!K("--no-sync")){var t=parseInt(function(t,e){var[,,...n]=process.argv;if(n.includes(t)){var e=n.at(n.indexOf(t)+1);return e?.startsWith("-")?void 0:e}if(e&&n.includes(e)){var t=n.at(n.indexOf(e)+1);return t?.startsWith("-")?void 0:t}}("--limit","-l"))||void 0,e=!K("--offline","-o"),r=!K("--autoclean","-a");await async function(t=100,e=!1,r=!1){var o=process.env.EXPORT_FILE;if(!o)throw new Error("No export file provided");var[i,c,m]=await Promise.all([j(n.join(A,"download.csv")),j(n.join(A,"download_other.csv")),j(n.join(A,"users.csv"))]);if(m.forEach((t=>b.addFromCache(t))),i.forEach((t=>U.addFromCache(t))),c.forEach((t=>P.addFromCache(t))),await async function(t=100,e){if(t<1)return[0,0];let n=t<100?t:100,r=0;var o=process.env.YOUTUBE_API_KEY;return _((async(i,c)=>{for(;;){var i=await c.messages.fetch({limit:n,before:e}).catch((t=>console.log(t)))||new a;r=[...i].length,e=i.last()?.id;let d=0,l=0;i.forEach((t=>{t.content.match(/https:\/\/(www\.)?youtu(\.be|be\.com\/watch\?).*/g)?.map((t=>t.match(/[a-zA-Z0-9-_]{11}/)?.[0]||null)).filter((t=>t)).map((async e=>{var n=`https://www.youtube.com/watch?v=${e}`;if(U.has(n))return;var[r]=t.embeds.filter((t=>t.url===n)),a=r?.title?.endsWith("...")||!r?.title;let i=r?.title||"";if(a&&o){var t=await fetch(`https://www.googleapis.com/youtube/v3/videos?id=${e}&part=snippet&fields=items(snippet(title))&key=${o}`),n=await t.json();i=n?.items?.[0]?.snippet?.title||r?.title||""}d++,b.add(t.author.id),U.add({authorId:t.author.id,date:s.timestampFrom(t.id),title:i,url:n})})),t.content.match(/https:\/\/(?:www|open)?\.?(?:spotify|soundcloud)\.com\/.*/g)?.map((e=>{if(P.has(e))return;var[n]=t.embeds.filter((t=>t.url===e));l++,b.add(t.author.id),P.add({authorId:t.author.id,date:s.timestampFrom(t.id),title:n?.title||"",url:e||""})}))}));var u=F(i.at(-1)?.id||""),p=F(i.at(0)?.id||"");if(console.log(`Got messages from: ${q}${u}${G} - ${q}${p}${G}`),n=(t-=100)<100?t:100,r<100||n<1)return[d,l]}}))}(t),U.newSongsCount>0&&e){var t=await async function(){return new Promise((t=>{var e=new d.auth.OAuth2(D,R,N),n=e.generateAuthUrl({access_type:"offline",prompt:"consent",scope:["https://www.googleapis.com/auth/youtube"],redirect_uri:N,client_id:D}),r=l.createServer((async(n,o)=>{var s=u.parse(n.url||""),a=new URLSearchParams(s.query||"").get("code");if(!a)return o.end();var{tokens:i}=await e.getToken(a);return e.setCredentials(i),o.end("Success!"),r.close(),t(e)}));r.on("connect",(t=>t.destroy())),r.listen(O),p(n)}))}(),e=await(async()=>_((async t=>t.user?.id||"")))();e&&b.add(e);var n=await Y(t);n.forEach((t=>{var n=`https://www.youtube.com/watch?v=${t.videoId}`,r=U.allSongs.filter((t=>t.url===n))?.[0]||{authorId:e,date:-1,title:t.title,url:n};U.addFromCache(r)})),await Promise.all([B(t,U.newSongs),r&&z(t,n)])}b.allFetched||await b.fetch(),await Promise.all([k(n.join(A,"download.csv"),U.allSongs),k(n.join(A,"download_other.csv"),P.allSongs),k(n.join(A,"users.csv"),b.users),k(`./download/${o}`,U.allSongs.concat(P.allSongs).map((t=>({author:b.getUser(t.authorId)?.name||null,title:t.title,url:t.url}))).sort(((t,e)=>t.author?.localeCompare(e?.author||"")||t.title.localeCompare(e.title)||t.url.localeCompare(e.url))))])}(t,e,r)}K("--stats","-s")&&await async function(){var[t,e,n]=await Promise.all([j("./download/users.csv"),j("./download/download.csv"),j("./download/download_other.csv")]);t.forEach((t=>b.addFromCache(t))),e.forEach((t=>U.addFromCache(t))),n.forEach((t=>U.addFromCache(t)));var r=U.allSongs,o=function(t){var e=t.filter((t=>t.date>M)).reduce(((t,e)=>({...t,[e.authorId]:(t[e.authorId]||0)+1})),{});return Object.entries(e).map((([t,e])=>({user:b.getUser(t),count:e})))}(r),s=X(r);await Promise.all([rt(o),et(s)])}(),K("--gist","-g")&&await async function(){return e.existsSync(T)||await function(){var t=process.env.GIST_URI;if(!t)throw new Error("No GIST URI specified");return W(["cd "+T,`git clone ${t} .`].join(" && "))}(),W(["cd "+T,"git add .",`git commit -m "${(new Date).toDateString()}"`,"git push origin main --force"].join(" && "))}()