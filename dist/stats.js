import{h as t,a as e,l as i,s as n,c as s,f as r}from"./songs-77a8e17e.js";import a from"sharp";import{line as o,curveBumpX as l,pie as d,arc as h}from"d3-shape";import{scaleUtc as p,scaleLinear as u}from"d3-scale";import c from"node:fs";import"csv-parser";import"d3-dsv";import"node:path";import"dotenv/config";import"node:child_process";import"discord.js";const m=864e5,f=30.44*m;function g(t){const e=new Date(t),i=e.getUTCFullYear(),n=e.getUTCMonth();return Date.UTC(i,n,1)}function b(i){const n=i.filter((e=>e.date>t)),[s,r]=(a=n.map((t=>t.date)),[Math.min(...a),Math.max(...a)]);var a;const o=function(...t){const e=Math.min(...t),i=Math.max(...t);return Math.ceil((i-e)/f)+1}(s,r),l=g(s),d=new Map(Array.from({length:o}).map(((t,e)=>[g(l+f*e+3*m),new Map])));n.forEach((t=>{const e=g(t.date),i=d.get(e)||new Map,n=t.authorId;i.set(n,(i.get(n)||0)+1)}));const h=new Map;return d.forEach(((t,e)=>{t.forEach(((t,i)=>{const n=h.get(i)||[...d.keys()].map((t=>({timestamp:t,value:0}))),[s]=n.filter((t=>t.timestamp===e));s&&(s.value=t,h.set(i,n))}))})),[...h.entries()].map((([t,i])=>({user:e.getUser(t),list:i,minTime:s,maxTime:r})))}const w=function(){const t=new Map;return{async get(e,i=128,n=128,s=95){t.has(e)||await this.fetch(e);const r=t.get(e);return new Promise((t=>a(r).resize(i,n).webp({quality:s}).toBuffer().then((t=>"data:image/jpeg;base64,"+t.toString("base64"))).then(t).finally((()=>t("")))))},fetch:async i=>new Promise((n=>{if(t.has(i))return n();const s=e.getUser(i);if(!s?.avatarUrl)return n();fetch(s.avatarUrl).then((t=>t.arrayBuffer())).then((t=>Buffer.from(t))).then((e=>t.set(i,e))).finally(n)}))}}();function A(t){const e=[],i=new Map;let n,s=null;return{get name(){return t},get childNodes(){return e},get attributes(){return i},set parentNode(t){s=t},get parentNode(){return s},get textContent(){return n||""},setTextContent(t){return n=`${t}`,this},setAttribute(t,e){return i.set(t,`${e}`),this},setPosition({x:t,y:e,width:i,height:n}){return void 0!==t&&this.setAttribute("x",t),void 0!==e&&this.setAttribute("y",e),void 0!==i&&this.setAttribute("width",i),void 0!==n&&this.setAttribute("height",n),this},appendChild(t){return e.push(t),t.parentNode=this,this},appendTo(t){return t.appendChild(this),this},render(){const i=Array.from(this.attributes.entries()).map((([t,e])=>`${t}="${e}"`)).join(" "),s=this.attributes.size>0,r=e.map((t=>t.render())).join("");return`<${t}${s?" ":""}${i}>${r}${n||""}</${t}>`}}}function x(t,e){const i=A("svg").setPosition({width:t,height:e}).setAttribute("viewbox",`0 0 ${t} ${e}`).setAttribute("xmlns","http://www.w3.org/2000/svg").setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink").setAttribute("fill","none"),n=A("defs");return{...i,get defs(){return n}}}async function v(t){const e=25*t[0].list.length,i=350,n=20,s=20,r=20,a=60,d=t[0].list.at(0)?.timestamp??0,h=t[0].list.at(-1)?.timestamp??0,m=Math.max(...t.map((t=>Math.max(...t.list.map((t=>t.value)))))),f=p().domain([d,h]).range([r,e-s]),g=u().domain([0,m]).range([i-a,n]),b=o().x((t=>f(t.timestamp))).y((t=>g(t.value))).curve(l),v=x(e,i).setAttribute("font-size",10),C=A("rect").setPosition({width:e,height:i}).setAttribute("fill","#222").appendTo(v);A("style").setTextContent(t.map((({user:e},i)=>`.u-${e.id}{animation:h ${4*t.length}s linear ${4*(i-1)}s infinite;opacity:0}`)).join("")+`@keyframes h{${[[0,0],[1/t.length-.002,0],[1/t.length-.001,1],[2/t.length+.001,1],[2/t.length+.002,0],[1,0]].map((([t,e])=>`${100*t}%{opacity:${e}}`)).join("")}}`).appendTo(v);const $=[],y=A("g").appendTo(v);t[0].list.forEach(((t,n,o)=>{const l=(e-s-r)/(o.length-1)*n+r-3,d=i-a+4,h=new Intl.DateTimeFormat("en-US",{month:"short"}),p=0===new Date(t.timestamp).getMonth(),u=p?new Date(t.timestamp).getFullYear():0,c=h.format(t.timestamp);y.appendChild(A("text").setPosition({x:l,y:d}).setAttribute("transform",`rotate(90 ${l} ${d})`).setAttribute("fill","#fff").setTextContent(c+(p?" "+u:"")))}));const T=A("g").appendTo(v);for(let t=0;t<=m;t++){if(t%10!=0&&t!==m)continue;const e=r-10,s=i-a-(i-n-a)/m*t;T.appendChild(A("text").setPosition({x:e,y:s}).setAttribute("fill","#fff").setTextContent(t))}const P=t.map((({list:t,user:s})=>new Promise((a=>{if(!s)return;const o=A("g");w.get(s.id,52,52).then((t=>{o.appendChild(A("image").setAttribute("xlink:href",t).setPosition({x:r+20,y:n+20,width:48,height:48}))})).then(a),o.setAttribute("class","u-"+s.id).appendChild(A("path").setAttribute("d",b([{timestamp:d,value:0},...t,{timestamp:h,value:0}])||"").setAttribute("stroke-width",1).setAttribute("stroke",s?.color||"red").setAttribute("fill",(s?.color||"#ff0000")+"40")).appendChild(A("text").setPosition({x:r+25+52,y:n+20+26}).setAttribute("font-size",20).setAttribute("fill",s.color||"red").setTextContent(s.name)),v.appendChild(o);const l=x(e,i).setAttribute("font-size",10).appendChild(C).appendChild(o).appendChild(y).appendChild(T),p=A("g").appendTo(l),u=t.reduce(((t,e)=>t+e.value),0)/t.length;t.forEach((t=>{A("circle").setAttribute("cx",f(t.timestamp)).setAttribute("cy",g(t.value)).setAttribute("r",2).setAttribute("fill","#fff").appendTo(p),t.value>u&&A("text").setAttribute("x",f(t.timestamp)-5).setAttribute("y",g(t.value)-6).setAttribute("fill","#fff").setTextContent(t.value).appendTo(p)})),$.push({content:l.render(),fileName:`${s.name}.svg`})}))));await Promise.all(P),c.writeFile("download/pmstats-timegraph-animated.svg",v.render(),(t=>t&&console.log(t))),$.forEach((({content:t,fileName:e})=>c.writeFile("download/pmstats-timegraph-user-"+e,t,(t=>t&&console.log(t)))))}const C=["#d9ed92","#b5e48c","#99d98c","#76c893","#52b69a","#34a0a4","#168aad","#1a759f","#1e6091","#184e77"];async function $(t){const e=60*t.length,i=20,n=20,s=(e-i-20)/2,r=x(600,e).setAttribute("font-size",10).appendChild(A("rect").setPosition({width:600,height:e}).setAttribute("fill","#222")),a=A("g").setAttribute("transform",`translate(${s+n},${s+i})`).appendTo(r),o=d().value((t=>t.count))(t),l=h().innerRadius(0).outerRadius(s),p=t.reduce(((t,e)=>t+e.count),0),u=t.map((({user:t,count:e},d)=>new Promise((h=>{a.appendChild(A("path").setAttribute("d",l(o[d])).setAttribute("fill",C[d]));let[u,c]=l.centroid(o[d]);u+=s+n,c+=s+i;const m=n+2*s+20,f=i+60*d;w.get(t.id,32,32).then((t=>{r.appendChild(A("image").setAttribute("xlink:href",t).setPosition({x:m+32,y:f+5,width:32,height:32}))})).then(h),r.appendChild(A("path").setAttribute("d",`M${u} ${c}l0 -10L${m} ${f}l20 0`).setAttribute("stroke",t?.color||"red")).appendChild(A("text").setTextContent(`${t?.name} ${Math.floor(e/p*1e3)/10}% (${e})`).setPosition({x:m+30,y:f}).setAttribute("fill",t?.color||"red"))}))));await Promise.all(u),c.writeFile("download/pmstats-piechart.svg",r.render(),(t=>t&&console.log(t)))}!async function(){const[a,o,l]=await Promise.all([i("./download/users.csv"),i("./download/download.csv"),i("./download/download_other.csv")]);a.forEach((t=>e.addFromCache(t))),o.forEach((t=>n.addFromCache(t))),l.forEach((t=>n.addFromCache(t)));const d=n.allSongs,h=function(i){const n=i.filter((e=>e.date>t)).reduce(((t,e)=>({...t,[e.authorId]:(t[e.authorId]||0)+1})),{});return Object.entries(n).map((([t,i])=>({user:e.getUser(t),count:i})))}(d),p=b(d);await Promise.all([$(h),v(p)]),s("--gist")&&await r("pmstats-*.svg")}();
