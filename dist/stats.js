import{h as t,a as e,l as n,s as i,c as s,f as r}from"./users-2d73db6e.js";import{scaleUtc as a,scaleLinear as o}from"d3-scale";import{line as l,curveBumpX as d,pie as u,arc as p}from"d3-shape";import h from"node:fs";import c from"sharp";import"csv-parser";import"d3-dsv";import"node:path";import"dotenv/config";import"node:child_process";import"discord.js";const m=864e5,f=30.44*m;function g(t){const e=new Date(t),n=e.getUTCFullYear(),i=e.getUTCMonth();return Date.UTC(n,i,1)}function b(n){const i=n.filter((e=>e.date>t)),[s,r]=(a=i.map((t=>t.date)),[Math.min(...a),Math.max(...a)]);var a;const o=function(...t){const e=Math.min(...t),n=Math.max(...t);return Math.ceil((n-e)/f)+1}(s,r),l=g(s),d=new Map(Array.from({length:o}).map(((t,e)=>[g(l+f*e+3*m),new Map])));i.forEach((t=>{const e=g(t.date),n=d.get(e)||new Map,i=t.authorId;n.set(i,(n.get(i)||0)+1)}));const u=new Map;return d.forEach(((t,e)=>{t.forEach(((t,n)=>{const i=u.get(n)||[...d.keys()].map((t=>({timestamp:t,value:0}))),[s]=i.filter((t=>t.timestamp===e));s&&(s.value=t,u.set(n,i))}))})),[...u.entries()].map((([t,n])=>({user:e.getUser(t),list:n,minTime:s,maxTime:r})))}const w=function(){const t=new Map;return{async get(e,n=128,i=128,s=95){t.has(e)||await this.fetch(e);const r=t.get(e);return new Promise((t=>c(r).resize(n,i).webp({quality:s}).toBuffer().then((t=>"data:image/jpeg;base64,"+t.toString("base64"))).then(t).finally((()=>t("")))))},fetch:async n=>new Promise((i=>{if(t.has(n))return i();const s=e.getUser(n);if(!s?.avatarUrl)return i();fetch(s.avatarUrl).then((t=>t.arrayBuffer())).then((t=>Buffer.from(t))).then((e=>t.set(n,e))).finally(i)}))}}();function A(t){const e=[],n=new Map;let i,s=null;return{get name(){return t},get childNodes(){return e},get attributes(){return n},set parentNode(t){s=t},get parentNode(){return s},get textContent(){return i||""},setTextContent(t){return i=`${t}`,this},setAttribute(t,e){return n.set(t,`${e}`),this},setPosition({x:t,y:e,width:n,height:i}){return void 0!==t&&this.setAttribute("x",t),void 0!==e&&this.setAttribute("y",e),void 0!==n&&this.setAttribute("width",n),void 0!==i&&this.setAttribute("height",i),this},appendChild(t){return e.push(t),t.parentNode=this,this},appendTo(t){return t.appendChild(this),this},render(){const n=Array.from(this.attributes.entries()).map((([t,e])=>`${t}="${e}"`)).join(" "),s=this.attributes.size>0,r=e.map((t=>t.render())).join("");return`<${t}${s?" ":""}${n}>${r}${i||""}</${t}>`}}}function x(t,e){const n=A("svg").setPosition({width:t,height:e}).setAttribute("viewbox",`0 0 ${t} ${e}`).setAttribute("xmlns","http://www.w3.org/2000/svg").setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink").setAttribute("fill","none"),i=A("defs");return{...n,get defs(){return i}}}async function v(t){const e=25*t[0].list.length,n=350,i=20,s=20,r=20,u=60,p=t[0].list.at(0)?.timestamp??0,c=t[0].list.at(-1)?.timestamp??0,m=Math.max(...t.map((t=>Math.max(...t.list.map((t=>t.value)))))),f=a().domain([p,c]).range([r,e-s]),g=o().domain([0,m]).range([n-u,i]),b=l().x((t=>f(t.timestamp))).y((t=>g(t.value))).curve(d),v=x(e,n).setAttribute("font-size",10),T=A("rect").setPosition({width:e,height:n}).setAttribute("fill","#222").appendTo(v);A("style").setTextContent(t.map((({user:e},n)=>`.u-${e.id}{animation:h ${4*t.length}s linear ${4*(n-1)}s infinite;opacity:0}`)).join("")+`@keyframes h{${[[0,0],[1/t.length-.002,0],[1/t.length-.001,1],[2/t.length+.001,1],[2/t.length+.002,0],[1,0]].map((([t,e])=>`${100*t}%{opacity:${e}}`)).join("")}}`).appendTo(v);const $=[],y=A("g").appendTo(v);t[0].list.forEach(((t,i,a)=>{const o=(e-s-r)/(a.length-1)*i+r-3,l=n-u+4,d=new Intl.DateTimeFormat("en-US",{month:"short"}),p=0===new Date(t.timestamp).getMonth(),h=p?new Date(t.timestamp).getFullYear():0,c=d.format(t.timestamp);y.appendChild(A("text").setPosition({x:o,y:l}).setAttribute("transform",`rotate(90 ${o} ${l})`).setAttribute("fill","#fff").setTextContent(c+(p?" "+h:"")))}));const C=A("g").appendTo(v);for(let t=0;t<=m;t++){if(t%10!=0&&t!==m)continue;const e=r-10,s=n-u-(n-i-u)/m*t;C.appendChild(A("text").setPosition({x:e,y:s}).setAttribute("fill","#fff").setTextContent(t))}for(const s of t){const{list:t,user:a}=s;if(!a)break;const o=A("g").appendTo(v),l=52,d=await w.get(a.id,l,l);A("image").setAttribute("xlink:href",d).setPosition({x:r+20,y:i+20,width:48,height:48}).appendTo(o),o.setAttribute("class","u-"+a.id),A("path").setAttribute("d",b([{timestamp:p,value:0},...t,{timestamp:c,value:0}])||"").setAttribute("stroke-width",1).setAttribute("stroke",a?.color||"red").setAttribute("fill",(a?.color||"#ff0000")+"40").appendTo(o),A("text").setPosition({x:r+25+l,y:i+20+l/2}).setAttribute("font-size",20).setAttribute("fill",a.color||"red").setTextContent(a.name).appendTo(o);const u=x(e,n).setAttribute("font-size",10).appendChild(T).appendChild(o).appendChild(y).appendChild(C),h=A("g").appendTo(u),m=t.reduce(((t,e)=>t+e.value),0)/t.length;t.forEach((t=>{A("circle").setAttribute("cx",f(t.timestamp)).setAttribute("cy",g(t.value)).setAttribute("r",2).setAttribute("fill","#fff").appendTo(h),t.value>m&&A("text").setAttribute("x",f(t.timestamp)-5).setAttribute("y",g(t.value)-6).setAttribute("fill","#fff").setTextContent(t.value).appendTo(h)})),$.push({content:u.render(),fileName:`${a.name}.svg`})}h.writeFile("download/pmstats-timegraph-animated.svg",v.render(),(t=>t&&console.log(t))),$.forEach((({content:t,fileName:e})=>h.writeFile("download/pmstats-timegraph-user-"+e,t,(t=>t&&console.log(t)))))}const T=["#d9ed92","#b5e48c","#99d98c","#76c893","#52b69a","#34a0a4","#168aad","#1a759f","#1e6091","#184e77"];async function $(t){const e=60*t.length,n=20,i=20,s=(e-n-20)/2,r=x(600,e).setAttribute("font-size",10).appendChild(A("rect").setPosition({width:600,height:e}).setAttribute("fill","#222")),a=A("g").setAttribute("transform",`translate(${s+i},${s+n})`).appendTo(r),o=u().value((t=>t.count))(t),l=p().innerRadius(0).outerRadius(s),d=t.reduce(((t,e)=>t+e.count),0),c=t.map((({user:t,count:e},u)=>new Promise((p=>{A("path").setAttribute("d",l(o[u])).setAttribute("fill",T[u]).appendTo(a);let[h,c]=l.centroid(o[u]);h+=s+i,c+=s+n;const m=i+2*s+20,f=n+60*u;w.get(t.id,32,32).then((t=>{A("image").setAttribute("xlink:href",t).setPosition({x:m+32,y:f+5,width:32,height:32}).appendTo(r)})).then(p),A("path").setAttribute("d",`M${h} ${c}l0 -10L${m} ${f}l20 0`).setAttribute("stroke",t?.color||"red").appendTo(r),A("text").setTextContent(`${t?.name} ${Math.floor(e/d*1e3)/10}% (${e})`).setPosition({x:m+30,y:f}).setAttribute("fill",t?.color||"red").appendTo(r)}))));await Promise.all(c),h.writeFile("download/pmstats-piechart.svg",r.render(),(t=>t&&console.log(t)))}!async function(){const[a,o,l]=await Promise.all([n("./download/users.csv"),n("./download/download.csv"),n("./download/download_other.csv")]);a.forEach((t=>e.addFromCache(t))),o.forEach((t=>i.addFromCache(t))),l.forEach((t=>i.addFromCache(t)));const d=i.allSongs,u=function(n){const i=n.filter((e=>e.date>t)).reduce(((t,e)=>({...t,[e.authorId]:(t[e.authorId]||0)+1})),{});return Object.entries(i).map((([t,n])=>({user:e.getUser(t),count:n})))}(d),p=b(d);await Promise.all([$(u),v(p)]),s("--gist")&&await r("pmstats-*.svg")}();
